"""
–£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –î–ï–¢–ê–õ–¨–ù–û–ô –∫–∞—Ä—Ç—ã –±–æ—Ç–∞
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É –≤ —Å—Ç–∏–ª–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π, —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏ –∏ —Ç.–¥.
"""
import os
import re
from pathlib import Path
from datetime import datetime

class DetailedBotAnalyzer:
    def __init__(self, handlers_path: str):
        self.handlers_path = Path(handlers_path)
        self.handlers = {}
        self.states = {}
        self.keyboards = {}
        self.messages = {}
        
    def analyze(self):
        """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞"""
        print("üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –±–æ—Ç–∞...")
        
        py_files = list(self.handlers_path.rglob("*.py"))
        py_files = [f for f in py_files if "__pycache__" not in str(f) and "__init__" not in str(f)]
        
        for file_path in py_files:
            self._analyze_file(file_path)
        
        print(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω")
    
    def _analyze_file(self, file_path: Path):
        """–ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
            self._extract_messages(content, file_path)
            
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {e}")
    
    def _extract_messages(self, content: str, file_path: Path):
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∫–æ–¥–∞"""
        # –ò—â–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ç—Ä–æ–π–Ω—ã—Ö –∫–∞–≤—ã—á–∫–∞—Ö –∏ –æ–±—ã—á–Ω—ã—Ö
        patterns = [
            r'text\s*=\s*["\']([^"\']+)["\']',
            r'\.answer\(["\']([^"\']+)["\']',
            r'\.edit_text\(["\']([^"\']+)["\']',
        ]
        
        for pattern in patterns:
            matches = re.finditer(pattern, content)
            for match in matches:
                text = match.group(1)
                if len(text) > 10:  # –¢–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ —Ç–µ–∫—Å—Ç—ã
                    if str(file_path) not in self.messages:
                        self.messages[str(file_path)] = []
                    self.messages[str(file_path)].append(text)
    
    def generate_detailed_map(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É"""
        md = "# üì± –ü–û–õ–ù–ê–Ø –ö–ê–†–¢–ê –ë–û–¢–ê \"–ü–û–ü–£–¢–ß–ò–ö\"\n\n"
        md += f"**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** {datetime.now().strftime('%d.%m.%Y %H:%M')}\n\n"
        md += "---\n\n"
        
        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∫ –≤–æ –≤—Ç–æ—Ä–æ–º —Ñ–∞–π–ª–µ
        md += self._generate_navigation_structure()
        md += self._generate_sections()
        
        return md
    
    def _generate_navigation_structure(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É"""
        nav = "## üó∫Ô∏è –°–¢–†–£–ö–¢–£–†–ê –ù–ê–í–ò–ì–ê–¶–ò–ò\n\n"
        nav += "```\n"
        nav += "üè† –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (/start, main_menu)\n"
        nav += "‚îÇ\n"
        nav += "‚îú‚îÄ üîç –ù–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç (search_route)\n"
        nav += "‚îÇ  ‚îú‚îÄ –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã\n"
        nav += "‚îÇ  ‚îî‚îÄ –§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫\n"
        nav += "‚îÇ     ‚îú‚îÄ –û—Ç–∫—É–¥–∞? (SearchStates.waiting_from)\n"
        nav += "‚îÇ     ‚îú‚îÄ –ö—É–¥–∞? (SearchStates.waiting_to)\n"
        nav += "‚îÇ     ‚îî‚îÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã\n"
        nav += "‚îÇ\n"
        nav += "‚îú‚îÄ üöó –°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç (create_route)\n"
        nav += "‚îÇ  ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è\n"
        nav += "‚îÇ  ‚îú‚îÄ –û—Ç–∫—É–¥–∞? (RouteCreate.waiting_for_from)\n"
        nav += "‚îÇ  ‚îú‚îÄ –ö—É–¥–∞? (RouteCreate.waiting_for_to)\n"
        nav += "‚îÇ  ‚îú‚îÄ –î–∞—Ç–∞ (RouteCreate.waiting_for_date)\n"
        nav += "‚îÇ  ‚îú‚îÄ –í—Ä–µ–º—è (RouteCreate.waiting_for_time) ‚è∞ –ë–ê–ì #24\n"
        nav += "‚îÇ  ‚îú‚îÄ –¶–µ–Ω–∞ (RouteCreate.waiting_for_price)\n"
        nav += "‚îÇ  ‚îú‚îÄ –ú–µ—Å—Ç–∞ (RouteCreate.waiting_for_seats)\n"
        nav += "‚îÇ  ‚îú‚îÄ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (RouteCreate.waiting_for_comment)\n"
        nav += "‚îÇ  ‚îî‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (RouteCreate.confirm)\n"
        nav += "‚îÇ\n"
        nav += "‚îú‚îÄ üß≥ –ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏ (my_trips)\n"
        nav += "‚îÇ  ‚îú‚îÄ –°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫\n"
        nav += "‚îÇ  ‚îú‚îÄ –î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏\n"
        nav += "‚îÇ  ‚îî‚îÄ –û—Ç–º–µ–Ω–∞ –∑–∞—è–≤–∫–∏\n"
        nav += "‚îÇ\n"
        nav += "‚îú‚îÄ üó∫Ô∏è –ú–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã (my_routes)\n"
        nav += "‚îÇ  ‚îú‚îÄ –°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤\n"
        nav += "‚îÇ  ‚îú‚îÄ –î–µ—Ç–∞–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞ (myroutes:details:ID)\n"
        nav += "‚îÇ  ‚îÇ  ‚îî‚îÄ –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤\n"
        nav += "‚îÇ  ‚îú‚îÄ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (myroutes:edit:ID) ‚úèÔ∏è –ë–ê–ì #18, #24\n"
        nav += "‚îÇ  ‚îÇ  ‚îú‚îÄ –ú–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n"
        nav += "‚îÇ  ‚îÇ  ‚îú‚îÄ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π\n"
        nav += "‚îÇ  ‚îÇ  ‚îú‚îÄ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (–ë–ê–ì #24)\n"
        nav += "‚îÇ  ‚îÇ  ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ë–ê–ì #22, #27)\n"
        nav += "‚îÇ  ‚îú‚îÄ –û—Ç–º–µ–Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞ (myroutes:cancel:ID)\n"
        nav += "‚îÇ  ‚îî‚îÄ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (myroutes:restore:ID)\n"
        nav += "‚îÇ\n"
        nav += "‚îî‚îÄ üë§ –ü—Ä–æ—Ñ–∏–ª—å (profile)\n"
        nav += "   ‚îú‚îÄ –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è\n"
        nav += "   ‚îú‚îÄ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (profile:edit)\n"
        nav += "   ‚îÇ  ‚îú‚îÄ –ò–º—è (EditProfileStates.waiting_for_name)\n"
        nav += "   ‚îÇ  ‚îú‚îÄ –û–ø–∏—Å–∞–Ω–∏–µ (EditProfileStates.waiting_for_bio)\n"
        nav += "   ‚îÇ  ‚îî‚îÄ –§–æ—Ç–æ (EditProfileStates.waiting_for_photo)\n"
        nav += "   ‚îî‚îÄ –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ (profile:delete)\n"
        nav += "```\n\n"
        nav += "---\n\n"
        
        return nav
    
    def _generate_sections(self) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–∞–∑–¥–µ–ª—ã –∫–∞—Ä—Ç—ã"""
        sections = ""
        
        # –†–∞–∑–¥–µ–ª: –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        sections += "## üöó –°–û–ó–î–ê–ù–ò–ï –ú–ê–†–®–†–£–¢–ê\n\n"
        sections += "### –ü–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä (CreateRoute FSM)\n\n"
        sections += "**–§–∞–π–ª:** `handlers/route_create.py`\n\n"
        sections += "**–≠—Ç–∞–ø—ã:**\n\n"
        sections += "1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è** - –µ—Å–ª–∏ –Ω–µ—Ç display_name ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞\n"
        sections += "2. **–û—Ç–∫—É–¥–∞?** - –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)\n"
        sections += "3. **–ö—É–¥–∞?** - –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)\n"
        sections += "4. **–î–∞—Ç–∞** - –∫–∞–ª–µ–Ω–¥–∞—Ä—å (—Ç–æ–ª—å–∫–æ –±—É–¥—É—â–∏–µ –¥–∞—Ç—ã)\n"
        sections += "5. **–í—Ä–µ–º—è** - –≤–≤–æ–¥ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (–ë–ê–ì #24)\n"
        sections += "   - –§–æ—Ä–º–∞—Ç—ã: 1, 9, 15, 1430, 14:30\n"
        sections += "   - –í–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ –¥–∞—Ç–∞ = —Å–µ–≥–æ–¥–Ω—è ‚Üí –≤—Ä–µ–º—è >= —Ç–µ–∫—É—â–µ–≥–æ\n"
        sections += "6. **–¶–µ–Ω–∞** - —Ü–µ–ª–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ\n"
        sections += "7. **–ú–µ—Å—Ç–∞** - –º–∏–Ω–∏–º—É–º 1\n"
        sections += "8. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π** - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ\n"
        sections += "9. **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ** - –ø–æ–∫–∞–∑ –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏\n\n"
        sections += "**–ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:**\n"
        sections += "- `üîô –ù–∞–∑–∞–¥` - –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ\n"
        sections += "- `‚ùå –û—Ç–º–µ–Ω–∏—Ç—å` - –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ\n"
        sections += "- `‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å` - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥\n\n"
        sections += "---\n\n"
        
        # –†–∞–∑–¥–µ–ª: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
        sections += "## ‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ú–ê–†–®–†–£–¢–ê\n\n"
        sections += "### –ú–µ—Ö–∞–Ω–∏–∑–º –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ë–ê–ì #18, #24)\n\n"
        sections += "**–§–∞–π–ª:** `handlers/my_routes/edit_handler.py`\n\n"
        sections += "**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**\n\n"
        sections += "1. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `changed_fields[]`\n"
        sections += "2. **–û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ \"–ì–æ—Ç–æ–≤–æ\"\n"
        sections += "3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ (–ë–ê–ì #24)**:\n"
        sections += "   - –ü—Ä–∏ –≤–≤–æ–¥–µ –Ω–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\n"
        sections += "   - –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ \"–ì–æ—Ç–æ–≤–æ\" (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)\n"
        sections += "4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä–∞–º (–ë–ê–ì #22, #27)**:\n"
        sections += "   - –§–æ—Ä–º–∞—Ç \"–±—ã–ª–æ ‚Üí —Å—Ç–∞–ª–æ\"\n"
        sections += "   - –ó–∞–¥–µ—Ä–∂–∫–∞ 0.3 —Å–µ–∫ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏\n"
        sections += "   - –¢–æ–ª—å–∫–æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞–º —Å accepted –∑–∞—è–≤–∫–∞–º–∏\n\n"
        sections += "**–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è:**\n"
        sections += "- –û—Ç–∫—É–¥–∞\n"
        sections += "- –ö—É–¥–∞\n"
        sections += "- –î–∞—Ç–∞ (–∫–∞–ª–µ–Ω–¥–∞—Ä—å)\n"
        sections += "- –í—Ä–µ–º—è (–≤–∞–ª–∏–¥–∞—Ü–∏—è –ë–ê–ì #24)\n"
        sections += "- –¶–µ–Ω–∞\n"
        sections += "- –ú–µ—Å—Ç–∞\n"
        sections += "- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–∑–∞–º–µ–Ω–∏—Ç—å/–¥–æ–ø–∏—Å–∞—Ç—å/—É–¥–∞–ª–∏—Ç—å)\n\n"
        sections += "---\n\n"
        
        # –†–∞–∑–¥–µ–ª: –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤
        sections += "## üîç –ü–û–ò–°–ö –ú–ê–†–®–†–£–¢–û–í\n\n"
        sections += "### –î–≤–∞ —Ä–µ–∂–∏–º–∞ –ø–æ–∏—Å–∫–∞\n\n"
        sections += "**–§–∞–π–ª:** `handlers/routes_list/search_handler.py`\n\n"
        sections += "**–†–µ–∂–∏–º 1: –í—Å–µ –º–∞—Ä—à—Ä—É—Ç—ã** (search_route)\n"
        sections += "- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –í–°–ï –∞–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã\n"
        sections += "- –ò—Å–∫–ª—é—á–∞–µ—Ç —Å–≤–æ–∏ –º–∞—Ä—à—Ä—É—Ç—ã (–ë–ê–ì #2)\n"
        sections += "- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –≤–æ–¥–∏—Ç–µ–ª—è\n\n"
        sections += "**–†–µ–∂–∏–º 2: –§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫** (search:start)\n"
        sections += "- –ë–ê–ì #3: –û–¥–Ω–æ –æ–∫–Ω–æ –¥–ª—è –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–æ–≤\n"
        sections += "- –®–∞–≥ 1: –û—Ç–∫—É–¥–∞?\n"
        sections += "- –®–∞–≥ 2: –ö—É–¥–∞? (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n"
        sections += "- –ö–Ω–æ–ø–∫–∞ \"–ü—Ä–∏–º–µ–Ω–∏—Ç—å\" - –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\n\n"
        sections += "**–ö–∞—Ä—Ç–æ—á–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞:**\n"
        sections += "- –ü—Ä–æ—Ñ–∏–ª—å –≤–æ–¥–∏—Ç–µ–ª—è (–∏–º—è, –±–∏–æ)\n"
        sections += "- –ú–∞—Ä—à—Ä—É—Ç (–æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞)\n"
        sections += "- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\n"
        sections += "- –¶–µ–Ω–∞ –∏ –º–µ—Å—Ç–∞\n"
        sections += "- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)\n"
        sections += "- –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–∞\n\n"
        sections += "**–ö–Ω–æ–ø–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:**\n"
        sections += "- üë§ –ü—Ä–æ—Ñ–∏–ª—å - –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –≤–æ–¥–∏—Ç–µ–ª—è\n"
        sections += "- üëã –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è - –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É\n"
        sections += "- üí¨ –ß–∞—Ç - –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º (–µ—Å–ª–∏ –µ—Å—Ç—å username)\n\n"
        sections += "---\n\n"
        
        # –†–∞–∑–¥–µ–ª: –ü—Ä–æ—Ñ–∏–ª—å
        sections += "## üë§ –ü–†–û–§–ò–õ–¨\n\n"
        sections += "**–§–∞–π–ª:** `handlers/profile/view.py`\n\n"
        sections += "**–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**\n"
        sections += "- –§–æ—Ç–æ (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ)\n"
        sections += "- –ò–º—è (display_name)\n"
        sections += "- –û–ø–∏—Å–∞–Ω–∏–µ (bio)\n"
        sections += "- –†–µ–π—Ç–∏–Ω–≥ (–ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤)\n"
        sections += "- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤\n\n"
        sections += "**–ë–ê–ì #15: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞**\n"
        sections += "- –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Üí \"–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å\"\n"
        sections += "- –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω ‚Üí \"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å\"\n\n"
        sections += "---\n\n"
        
        # –†–∞–∑–¥–µ–ª: FSM –°–æ—Å—Ç–æ—è–Ω–∏—è
        sections += "## üîÑ FSM –°–û–°–¢–û–Ø–ù–ò–Ø (State Machines)\n\n"
        sections += "### RouteCreate\n"
        sections += "```\n"
        sections += "waiting_for_from ‚Üí waiting_for_to ‚Üí waiting_for_date ‚Üí \n"
        sections += "waiting_for_time ‚Üí waiting_for_price ‚Üí waiting_for_seats ‚Üí \n"
        sections += "waiting_for_comment ‚Üí confirm\n"
        sections += "```\n\n"
        
        sections += "### EditRoute\n"
        sections += "```\n"
        sections += "waiting_for_value (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π)\n"
        sections += "```\n\n"
        
        sections += "### SearchStates\n"
        sections += "```\n"
        sections += "waiting_from ‚Üí waiting_to\n"
        sections += "```\n\n"
        
        sections += "### EditProfileStates\n"
        sections += "```\n"
        sections += "waiting_for_name / waiting_for_bio / waiting_for_photo\n"
        sections += "```\n\n"
        
        sections += "---\n\n"
        
        # –†–∞–∑–¥–µ–ª: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –±–∞–≥–∏
        sections += "## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ë–ê–ì–ò\n\n"
        sections += "### –ë–ê–ì #24 - –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\n"
        sections += "**–§–∞–π–ª—ã:** `route_create.py`, `edit_handler.py`\n\n"
        sections += "**–ü—Ä–æ–±–ª–µ–º–∞:**\n"
        sections += "- –ú–æ–∂–Ω–æ –±—ã–ª–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n\n"
        sections += "**–†–µ—à–µ–Ω–∏–µ:**\n"
        sections += "- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –≤—Ä–µ–º–µ–Ω–∏\n"
        sections += "- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è)\n"
        sections += "- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `time()` –æ–±—ä–µ–∫—Ç—ã\n\n"
        
        sections += "### –ë–ê–ì #18 - –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ\n"
        sections += "**–§–∞–π–ª:** `edit_handler.py`\n\n"
        sections += "**–ü—Ä–æ–±–ª–µ–º–∞:**\n"
        sections += "- –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è–ª–∏—Å—å –≤ –ë–î —Å—Ä–∞–∑—É –ø—Ä–∏ –≤–≤–æ–¥–µ\n\n"
        sections += "**–†–µ—à–µ–Ω–∏–µ:**\n"
        sections += "- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `changed_fields[]`\n"
        sections += "- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –ø—Ä–∏ \"–ì–æ—Ç–æ–≤–æ\"\n\n"
        
        sections += "### –ë–ê–ì #3 - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–∫–æ–Ω –ø—Ä–∏ –ø–æ–∏—Å–∫–µ\n"
        sections += "**–§–∞–π–ª:** `search_handler.py`\n\n"
        sections += "**–ü—Ä–æ–±–ª–µ–º–∞:**\n"
        sections += "- –°–æ–∑–¥–∞–≤–∞–ª–æ—Å—å –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –Ω–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å\n\n"
        sections += "**–†–µ—à–µ–Ω–∏–µ:**\n"
        sections += "- –û–¥–Ω–æ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ\n"
        sections += "- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `bot_message_id` –≤ state\n\n"
        
        sections += "---\n\n"
        
        return sections
    
    def save_map(self, output_file: str):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞—Ä—Ç—É"""
        map_content = self.generate_detailed_map()
        
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(map_content)
        
        print(f"\n‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {output_file}")
        print(f"üìä –†–∞–∑–º–µ—Ä: {len(map_content)} —Å–∏–º–≤–æ–ª–æ–≤")

def main():
    handlers_path = Path(__file__).parent / "handlers"
    
    print("=" * 60)
    print("üó∫Ô∏è –ì–ï–ù–ï–†–ê–¢–û–† –î–ï–¢–ê–õ–¨–ù–û–ô –ö–ê–†–¢–´ –ë–û–¢–ê")
    print("=" * 60)
    print()
    
    analyzer = DetailedBotAnalyzer(handlers_path)
    analyzer.analyze()
    
    output_file = Path(__file__).parent / "–ö–ê–†–¢–ê_–ë–û–¢–ê_–ü–û–õ–ù–ê–Ø.md"
    analyzer.save_map(output_file)
    
    print()
    print("=" * 60)
    print("‚úÖ –ì–û–¢–û–í–û!")
    print("=" * 60)
    print()
    print("üìÑ –§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã:")
    print("   1. –ö–ê–†–¢–ê_–ë–û–¢–ê_–ß–ï–†–ù–û–í–ò–ö.md - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑")
    print("   2. –ö–ê–†–¢–ê_–ë–û–¢–ê_–ü–û–õ–ù–ê–Ø.md - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞")
    print()

if __name__ == "__main__":
    main()